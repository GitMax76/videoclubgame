<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoClub: Save the Store!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="preload" href="https://w.soundcloud.com/player/api.js" as="script">
    <style>
        /* --- AESTHETICS: 90s/00s CARTOON STYLE --- */
        :root {
            --bb-blue: #101696;
            --bb-yellow: #fdb900;
            --toon-purple: #8800ff;
            --toon-green: #ccff00;
            --toon-bg: #e0e0e0;
            --paper-white: #fdfdfd;
        }

        body {
            font-family: 'Patrick Hand', cursive;
            background-color: var(--toon-bg);
            background-image:
                radial-gradient(var(--bb-yellow) 15%, transparent 16%),
                radial-gradient(var(--bb-blue) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow-x: hidden;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            /* Mobile tap fix */
            user-select: none;
        }

        h1,
        h2,
        h3,
        .btn-font {
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
        }

        /* The "Squiggle" Effect */
        .squiggle-box {
            background: var(--paper-white);
            border: 3px solid black;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.8);
            transition: all 0.2s ease;
            animation: boil 3s infinite;
        }

        @keyframes boil {
            0% {
                border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            }

            50% {
                border-radius: 235px 10px 245px 15px / 20px 235px 15px 245px;
            }

            100% {
                border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            }
        }

        /* OCTAGON SHAPE */
        .octagon-shape {
            clip-path: polygon(29.29% 0%, 70.71% 0%, 100% 29.29%, 100% 70.71%, 70.71% 100%, 29.29% 100%, 0% 70.71%, 0% 29.29%);
        }

        /* CRT Filter */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            opacity: 0.3;
        }

        .glitch {
            position: relative;
            color: var(--bb-yellow);
            text-shadow: 2px 2px var(--bb-blue);
        }

        /* Interactive Tape */
        .vhs-tape {
            width: 40px;
            height: 60px;
            border: 2px solid black;
            border-radius: 2px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.7rem;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .vhs-tape::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            height: 20%;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Selection States */
        .vhs-tape.selected {
            transform: translateY(-15px) scale(1.2) rotate(0deg) !important;
            box-shadow: 0 0 15px 4px var(--toon-green);
            z-index: 50;
            border-color: white;
            border-width: 3px;
        }

        .slot {
            background: #ddd;
            border: 2px dashed #999;
            height: 64px;
            width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .slot.playable {
            background-color: #e8f5e9;
            border-color: #4caf50;
            cursor: pointer;
        }

        .slot.playable:active {
            background-color: #c8e6c9;
        }

        .discard-zone.playable {
            transform: scale(1.05) rotate(6deg);
            border-color: red;
            background-color: #b71c1c;
            cursor: pointer;
        }

        /* Genres */
        .tape-red {
            background: #e53935;
        }

        .tape-blue {
            background: #1e88e5;
        }

        .tape-yellow {
            background: #fdd835;
            color: black;
        }

        .tape-black {
            background: #212121;
        }

        .meeple {
            width: 40px;
            height: 40px;
            position: absolute;
            transition: all 0.5s ease;
            z-index: 30;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.8));
        }

        .obj-card-common {
            background: #fff9c4;
            border: 1px solid #fbc02d;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            font-family: 'Patrick Hand', cursive;
            transform: rotate(-2deg);
        }

        .obj-card-personal {
            background: #e3f2fd;
            border: 2px solid #1565c0;
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.8);
            font-family: 'Patrick Hand', cursive;
            transform: rotate(1deg);
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bb-blue);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bb-yellow);
            border: 2px solid black;
        }

        .tab-btn.active {
            background: var(--bb-yellow);
            color: var(--bb-blue);
            transform: translateY(-5px);
            box-shadow: 3px 3px 0 black;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            overflow: hidden;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.8s ease-out;
            border: 20px solid #111;
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.9);
        }

        .splash-content {
            text-align: center;
            position: relative;
            transform: rotate(-2deg);
        }

        .logo-top {
            font-family: 'Patrick Hand', cursive;
            font-size: 3rem;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            display: block;
            margin-bottom: -20px;
            margin-left: -150px;
            transform: rotate(-5deg);
            opacity: 0.9;
        }

        .logo-main {
            font-family: 'Bangers', cursive;
            font-size: 10rem;
            line-height: 0.8;
            color: var(--bb-yellow);
            text-shadow:
                6px 6px 0 var(--bb-blue),
                -3px -3px 0 var(--toon-purple),
                10px 10px 20px rgba(0, 0, 0, 0.5);
            animation: pulse-glow 2s infinite alternate;
            display: block;
        }

        .logo-sub {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            background: white;
            color: black;
            padding: 2px 10px;
            display: inline-block;
            transform: rotate(3deg) translateY(-20px);
            margin-right: -180px;
            border: 2px solid black;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.5);
        }

        .vhs-ui {
            font-family: 'Courier New', monospace;
            color: #fff;
            font-size: 2rem;
            text-shadow: 2px 2px 0 #000;
            position: absolute;
            width: 100%;
            pointer-events: none;
        }

        .vhs-play {
            position: absolute;
            top: 40px;
            left: 40px;
            animation: blink 2s infinite;
        }

        .vhs-sp {
            position: absolute;
            top: 40px;
            right: 40px;
        }

        .click-start {
            font-family: 'Bangers', cursive;
            color: var(--toon-green);
            font-size: 4rem;
            text-shadow: 3px 3px 0 black;
            animation: blink 0.8s step-end infinite;
            margin-top: 3rem;
        }

        /* TV Turn On Effect */
        @keyframes turn-on {
            0% {
                transform: scale(1, 0.005) translate3d(0, 0, 0);
            }

            33% {
                transform: scale(1, 0.005) translate3d(0, 0, 0);
            }

            66% {
                transform: scale(0.4, 0.005) translate3d(0, 0, 0);
            }

            100% {
                transform: scale(1, 1) translate3d(0, 0, 0);
            }
        }

        @keyframes pulse-glow {
            from {
                text-shadow: 4px 4px 0 var(--bb-blue), -2px -2px 0 var(--toon-purple);
            }

            to {
                text-shadow: 4px 4px 20px var(--bb-yellow), -2px -2px 0 var(--toon-purple);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(-3deg);
            }

            50% {
                transform: translateY(-10px) rotate(-1deg);
            }
        }

        /* Hide content until ready if needed, currently just overlaying */
        /* Animated Background Tapes */
        /* Animated Background Tapes */
        .bg-tape {
            position: absolute;
            width: 260px;
            height: 160px;
            background: #222;
            border-radius: 8px;
            box-shadow: 10px 20px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 15px;
            opacity: 0.7;
            pointer-events: none;
            z-index: 0;
            filter: blur(1px);
        }

        /* Top Label */
        .tape-label {
            width: 220px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Lines on label */
        .tape-label::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 10px;
            right: 10px;
            height: 2px;
            background: #ccc;
            box-shadow: 0 -6px 0 #ccc;
        }

        /* Window Area */
        .tape-window {
            width: 220px;
            height: 60px;
            background: #111;
            border-radius: 4px;
            border: 2px solid #444;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            overflow: hidden;
        }

        /* Plastic Window Sheen */
        .tape-window::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        /* Reels */
        .tape-reel {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #eee;
            border: 8px solid white;
            box-shadow: inset 0 0 0 2px #ccc;
            position: relative;
        }

        .tape-reel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: black;
            border-radius: 50%;
        }

        /* Spool teeth */
        .tape-reel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(0deg, transparent 45%, #ccc 45%, #ccc 55%, transparent 55%),
                linear-gradient(90deg, transparent 45%, #ccc 45%, #ccc 55%, transparent 55%);
            border-radius: 50%;
        }

        /* Bottom Detail */
        .tape-bottom {
            width: 100%;
            flex-grow: 1;
            background-image: linear-gradient(90deg, transparent 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 20px 100%;
            opacity: 0.3;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        @keyframes float-tape {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            33% {
                transform: translate(40px, -30px) rotate(5deg) scale(1.05);
            }

            66% {
                transform: translate(-20px, 40px) rotate(-3deg) scale(0.95);
            }

            100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
        }

        /* --- VHS FIX OVERRIDES --- */
        /* Animated Background Tapes - PNG Assets */
        .bg-tape {
            position: absolute;
            width: 320px !important;
            height: 180px !important;
            background-color: transparent !important;
            background-size: contain !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            box-shadow: none !important;
            border-radius: 0 !important;

            /* Visibility & Polish */
            /* opacity is now handled via JS for randomization */
            opacity: var(--tape-opacity, 0.9) !important;

            /* White glow to separate from black background */
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.15)) !important;

            display: block !important;
            padding-top: 0 !important;
            pointer-events: none !important;
            z-index: 1 !important;
            /* Ensure above bg */
        }

        /* Color Shifting Animation Class (Applied via JS) */
        .shift-colors {
            animation: float-tape var(--float-duration, 20s) ease-in-out infinite var(--float-delay, 0s),
                shift-hue var(--shift-duration, 15s) linear infinite !important;
        }

        /* Ensure UI is on top */
        .vhs-ui {
            position: relative;
            z-index: 50 !important;
        }

        /* Hide CSS construction elements just in case */
        .bg-tape::before,
        .tape-window,
        .tape-reel,
        .tape-bottom,
        .tape-label {
            display: none !important;
        }

        @keyframes float-tape {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(var(--base-scale, 0.9));
            }

            33% {
                transform: translate(50px, -30px) rotate(4deg) scale(calc(var(--base-scale, 0.9) * 1.05));
            }

            66% {
                transform: translate(-30px, 40px) rotate(-3deg) scale(calc(var(--base-scale, 0.9) * 0.95));
            }

            100% {
                transform: translate(0, 0) rotate(0deg) scale(var(--base-scale, 0.9));
            }
        }

        @keyframes shift-hue {
            0% {
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.15)) hue-rotate(0deg);
            }

            50% {
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.15)) hue-rotate(180deg);
            }

            100% {
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.15)) hue-rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8">
    <!-- SPLASH SCREEN -->
    <div id="splash-screen" onclick="dismissSplash()">
        <!-- Background Container -->
        <div id="splash-bg" class="absolute inset-0 w-full h-full overflow-hidden" style="z-index: -1;"></div>

        <div class="vhs-ui">
            <div class="vhs-play">PLAY &#9658;</div>
            <div class="vhs-sp">SP</div>
        </div>

        <div class="splash-content">
            <span class="logo-top">The Last</span>
            <span class="logo-main">VideoClub</span>
            <span class="logo-sub">BOARDGAME</span>
        </div>

        <div class="click-start">PRESS PLAY &gt; TO START!</div>
    </div>
    <div class="crt-overlay"></div>

    <!-- SOUNDCLOUD WIDGET (HIDDEN) -->
    <iframe id="sc-widget" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/synthwave80s/sets/dreams&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true"
        style="opacity:0; position:absolute; z-index:-1; pointer-events:none;">
    </iframe>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-10">

        <!-- HEADER -->
        <div class="lg:col-span-12 text-center mb-4">
            <h1 class="glitch text-5xl md:text-8xl transform -rotate-2">VideoClub</h1>
            <p
                class="text-lg md:text-2xl text-white bg-blue-900 inline-block px-6 py-2 transform rotate-1 border-4 border-black shadow-[4px_4px_0_rgba(0,0,0,1)] rounded-sm font-bangers tracking-wide mt-2">
                Collaboriamo per non fallire...ma solo il migliore diventer√† Store Manager
            </p>
        </div>

        <!-- LEFT COLUMN: RULES -->
        <div id="left-column" class="lg:col-span-4 flex flex-col gap-4">
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="switchTab('intro')" id="btn-intro"
                    class="tab-btn active btn-font bg-blue-900 text-white px-3 py-2 rounded border-2 border-black hover:bg-yellow-400 hover:text-blue-900 transition-all text-sm">Intro</button>
                <button onclick="switchTab('turn')" id="btn-turn"
                    class="tab-btn btn-font bg-blue-900 text-white px-3 py-2 rounded border-2 border-black hover:bg-yellow-400 hover:text-blue-900 transition-all text-sm">Regole</button>

                <!-- FULL RULES LINK -->
                <a href="rules.html"
                    class="tab-btn btn-font bg-indigo-800 text-white px-3 py-2 rounded border-2 border-black hover:bg-yellow-300 hover:text-indigo-900 transition-all text-center no-underline flex items-center shadow-md text-sm">
                    üìú Regolamento Interattivo
                </a>

                <div class="flex flex-col items-center">
                    <button onclick="toggleMusic()" id="btn-music"
                        class="tab-btn btn-font bg-slate-800 text-white px-3 py-2 rounded border-2 border-black hover:bg-slate-700 active:scale-95 transition-all text-sm flex items-center gap-1">
                        üéµ AUDIO: OFF
                    </button>
                    <span class="text-[10px] text-gray-500 font-bold mt-1">Music by: Synthwave80s</span>
                </div>
                <!-- BUTTON TO EDITOR -->
                <a href="cardseditor.html"
                    class="tab-btn btn-font bg-purple-700 text-white px-3 py-2 rounded border-2 border-black hover:bg-purple-500 hover:scale-105 transition-all text-center no-underline flex items-center shadow-md text-sm">
                    üé® Crea una Carta Obiettivo
                </a>
                <button onclick="document.getElementById('contacts-footer').scrollIntoView({behavior: 'smooth'})"
                    class="tab-btn btn-font bg-green-700 text-white px-3 py-2 rounded border-2 border-black hover:bg-green-500 hover:scale-105 transition-all text-sm flex items-center shadow-md">
                    üìû Contatti
                </button>
            </div>

            <div class="squiggle-box p-4 md:p-6 flex-grow h-[300px] lg:h-[600px] overflow-y-auto relative bg-white">
                <!-- INTRO -->
                <div id="content-intro" class="block">
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <div class="flex-1">
                            <h2 class="text-4xl text-blue-800 mb-2 font-bangers">üìº Benvenuti al VideoClub!</h2>
                            <p class="mb-4 text-2xl italic text-gray-600 font-bangers">"Dove il cinema √® ancora una
                                cassetta da riavvolgere."</p>

                            <p class="mb-4 text-xl">Siete i commessi dell‚Äôultimo negozio della catena
                                <strong>VideoClub</strong>. I tempi sono duri, la concorrenza digitale incombe, e il
                                fallimento √® dietro l'angolo. Il vecchio Store Manager sta per andare in pensione e
                                cerca un sostituto...
                            </p>

                            <div
                                class="bg-yellow-100 p-4 border-l-8 border-yellow-500 mb-6 transform -rotate-1 shadow-sm">
                                <h3 class="font-bold text-yellow-800 text-xl font-bangers">Semi-Cooperativo?</h3>
                                <p class="text-lg">Esatto! Se il negozio fallisce (troppi clienti insoddisfatti),
                                    <strong>tutti perdono il lavoro</strong>. Ma se si salva... solo chi ha lavorato
                                    meglio otterr√† la promozione a <strong>Manager</strong>!
                                </p>
                            </div>
                        </div>
                        <div class="flex-1 bg-slate-100 p-4 rounded border-2 border-dashed border-gray-400">
                            <h3 class="text-2xl text-purple-700 font-bold font-bangers">La vostra missione:</h3>
                            <ul class="list-disc pl-5 space-y-2 mt-2 text-lg">
                                <li><strong>Collaborare</strong>: (Richieste dello Store Manager) riempiendo gli
                                    scaffali condivisi con i vostri vicini.</li>
                                <li><strong>Competere</strong>: Organizzate il vostro scaffale personale per soddisfare
                                    le richieste dei clienti (Richieste Clienti).</li>
                                <li><strong>Attenti al Tempo</strong>: Ogni pila sul tavolo rappresenta un'ora del
                                    turno. Quando finiscono, il negozio chiude!</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- RULES -->
                <!-- RULES -->
                <div id="content-turn" class="hidden">
                    <div class="space-y-6">
                        <!-- SECTION 1: GOAL -->
                        <div class="bg-blue-100 p-4 rounded border-2 border-blue-400 shadow-sm transform rotate-1">
                            <h2 class="text-3xl text-blue-900 mb-2 font-bangers">üèÜ Scopo del Gioco</h2>
                            <p class="text-lg leading-snug">
                                <strong>Semi-Cooperativo:</strong> Il Videoclub si salva se completate <strong>5
                                    Obiettivi Comuni</strong>.
                                Se fallite <strong>3 Obiettivi</strong>, il negozio chiude e <strong>tutti
                                    perdono</strong>.
                                <br><span class="text-sm italic text-blue-700">(Se il negozio √® salvo, vince chi ha pi√π
                                    punti personali!)</span>
                            </p>
                        </div>

                        <!-- SECTION 2: TURN STRUCTURE -->
                        <div>
                            <h3
                                class="text-2xl text-purple-800 font-bangers mb-2 border-b-4 border-purple-300 inline-block">
                                ‚è±Ô∏è Il Tuo Turno</h3>
                            <ol class="list-decimal pl-5 space-y-3 text-lg font-bold text-gray-800">
                                <li>
                                    <span class="text-purple-700">MUOVI MANAGER:</span>
                                    <span class="font-normal block text-base text-gray-600">Sposta il Manager di
                                        <strong>1 o 2 spazi</strong> in senso orario.</span>
                                </li>
                                <li>
                                    <span class="text-purple-700">PRENDI PILA:</span>
                                    <span class="font-normal block text-base text-gray-600">Prendi
                                        <strong>TUTTE</strong> le cassette dalla pila scelta.</span>
                                </li>
                                <li>
                                    <span class="text-purple-700">PIAZZA:</span>
                                    <ul class="list-disc pl-5 font-normal text-base text-gray-700 mt-1 space-y-1">
                                        <li><strong>2 Cassette</strong> sul TUO Scaffale Personale.</li>
                                        <li><strong>1 Cassetta</strong> sullo Scaffale a <strong>SINISTRA</strong> (tua
                                            colonna B).</li>
                                        <li><strong>1 Cassetta</strong> sullo Scaffale a <strong>DESTRA</strong> (tua
                                            colonna A).</li>
                                        <li class="text-red-600 italic">Il resto si scarta nel Box! (Attento al limite)
                                        </li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <!-- SECTION 3: END GAME -->
                        <div class="bg-red-50 p-3 rounded border-l-4 border-red-500">
                            <h4 class="text-lg font-bold text-red-900 font-bangers">‚ö†Ô∏è Fine Giro (8 Ore)</h4>
                            <p class="text-sm">Quando il Manager completa un giro, si controllano gli <strong>Obiettivi
                                    Comuni</strong>.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: INTERACTIVE GAME -->
        <div id="right-column" class="lg:col-span-8 flex flex-col gap-4">

            <!-- SIMULATOR HEADER (New) -->
            <div id="simulator-header"
                class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-3 rounded-lg border-2 border-black shadow-md flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üìº</span>
                    <div>
                        <h3 class="font-bangers text-xl leading-none tracking-wide text-yellow-300">PROVA A GIOCARE
                            SUBITO!</h3>
                        <p class="text-xs font-bold text-blue-100">SIMULA UN TURNO PER CAPIRE LE REGOLE</p>
                    </div>
                </div>
            </div>

            <!-- TURN SEQUENCE PROGRESS BAR -->
            <div id="turn-sequence-bar"
                class="flex items-center justify-between bg-white border-2 border-black rounded-lg p-2 shadow-sm text-xs md:text-sm">
                <!-- Step 1: Muovi -->
                <div id="seq-step-0" class="flex flex-col items-center opacity-40 transition-opacity font-bold">
                    <span
                        class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center mb-1">1</span>
                    <span class="text-blue-900">MUOVI</span>
                </div>
                <div class="flex-grow border-t-2 border-dashed border-gray-400 mx-2"></div>

                <!-- Step 2: Prendi -->
                <div id="seq-step-1" class="flex flex-col items-center opacity-40 transition-opacity font-bold">
                    <span
                        class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center mb-1">2</span>
                    <span class="text-purple-900">PRENDI</span>
                </div>
                <div class="flex-grow border-t-2 border-dashed border-gray-400 mx-2"></div>

                <!-- Step 3: Piazza -->
                <div id="seq-step-2" class="flex flex-col items-center opacity-40 transition-opacity font-bold">
                    <span
                        class="bg-amber-500 text-white w-6 h-6 rounded-full flex items-center justify-center mb-1">3</span>
                    <span class="text-amber-800">PIAZZA</span>
                </div>
                <div class="flex-grow border-t-2 border-dashed border-gray-400 mx-2"></div>

                <!-- Step 4: Passa -->
                <div id="seq-step-3" class="flex flex-col items-center opacity-40 transition-opacity font-bold">
                    <span
                        class="bg-green-600 text-white w-6 h-6 rounded-full flex items-center justify-center mb-1">4</span>
                    <span class="text-green-900">PASSA</span>
                </div>
            </div>

            <!-- CONTROLS PANEL (Dynamic) -->
            <div
                class="bg-yellow-400 border-4 border-black p-4 rounded-xl shadow-[8px_8px_0_rgba(0,0,0,1)] flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                    <div class="text-xl font-bold font-bangers">AZIONI:</div>
                </div>

                <div id="controls-container" class="flex gap-2 flex-wrap justify-center">
                    <!-- Buttons injected by JS based on phase -->
                </div>
            </div>

            <div id="game-status"
                class="bg-black text-green-400 font-mono px-4 py-2 rounded w-full text-sm border-2 border-gray-600 shadow-lg text-center md:text-left">
                STATUS: Caricamento...
            </div>

            <!-- BOARD AREA -->
            <div
                class="squiggle-box p-2 md:p-4 bg-slate-200 relative min-h-[600px] flex flex-col items-center justify-center overflow-hidden select-none">

                <!-- THE OCTAGON DESK -->
                <div class="relative w-72 h-72 md:w-80 md:h-80 mb-8 flex-shrink-0 transition-all duration-500">
                    <div
                        class="absolute inset-0 bg-[#8d6e63] border-[6px] border-[#5d4037] octagon-shape flex items-center justify-center shadow-xl">
                        <div
                            class="w-full h-full border-[20px] border-[#795548] octagon-shape flex items-center justify-center">
                            <span class="text-[#3e2723] font-bold text-3xl opacity-50 rotate-[-15deg]">DESK</span>
                        </div>
                    </div>

                    <!-- Piles -->
                    <div id="pile-0" class="absolute top-[-25px] left-1/2 -translate-x-1/2 pile-container z-20"></div>
                    <div id="pile-1"
                        class="absolute top-[14.6%] right-[14.6%] translate-x-[50%] translate-y-[-50%] rotate-[45deg] pile-container z-20 origin-center">
                    </div>
                    <div id="pile-2"
                        class="absolute top-1/2 right-[-25px] -translate-y-1/2 rotate-90 pile-container z-20 origin-center">
                    </div>
                    <div id="pile-3"
                        class="absolute bottom-[14.6%] right-[14.6%] translate-x-[50%] translate-y-[50%] rotate-[135deg] pile-container z-20 origin-center">
                    </div>
                    <div id="pile-4"
                        class="absolute bottom-[-25px] left-1/2 -translate-x-1/2 rotate-180 pile-container z-20 origin-center">
                    </div>
                    <div id="pile-5"
                        class="absolute bottom-[14.6%] left-[14.6%] translate-x-[-50%] translate-y-[50%] rotate-[225deg] pile-container z-20 origin-center">
                    </div>
                    <div id="pile-6"
                        class="absolute top-1/2 left-[-25px] -translate-y-1/2 rotate-[270deg] pile-container z-20 origin-center">
                    </div>
                    <div id="pile-7"
                        class="absolute top-[14.6%] left-[14.6%] translate-x-[-50%] translate-y-[-50%] rotate-[315deg] pile-container z-20 origin-center">
                    </div>

                    <!-- Store Manager Meeple -->
                    <div id="manager-meeple"
                        class="meeple top-[-40px] left-1/2 -translate-x-1/2 z-30 pointer-events-none">
                        <svg viewBox="0 0 512 512" class="w-full h-full drop-shadow-md">
                            <path
                                d="M256,0C199.6,0,153.8,45.8,153.8,102.2c0,18.1,4.9,35,13.5,49.8L53.6,281.3c-14.7,16.7-18,41-8.2,60.8 c9.8,19.8,30.3,32.4,52.4,32.4h316.4c22.1,0,42.6-12.6,52.4-32.4c9.8-19.8,6.5-44.1-8.2-60.8L344.7,152c8.6-14.8,13.5-31.7,13.5-49.8 C358.2,45.8,312.4,0,256,0z"
                                fill="#8800ff" stroke="black" stroke-width="20" />
                            <path d="M256,120 L240,180 L256,220 L272,180 Z" fill="#ccff00" stroke="black"
                                stroke-width="5" />
                        </svg>
                    </div>
                </div>

                <!-- CARDS & PLAYER AREA -->
                <div class="w-full flex flex-wrap md:flex-nowrap justify-between items-end gap-2 mt-4 relative">
                    <!-- Shared Left -->
                    <div class="flex flex-col items-center order-1 md:order-1">
                        <div class="text-sm font-bold bg-white px-2 border border-black mb-1 -rotate-3">Shared SX</div>
                        <div
                            class="bg-orange-200 border-2 border-black p-1 grid grid-cols-2 gap-1 w-[80px] md:w-[100px]">
                            <div class="flex flex-col gap-1 opacity-50 bg-gray-300">
                                <div class="slot h-8 w-full"></div>
                                <div class="slot h-8 w-full"></div>
                                <div class="slot h-8 w-full"></div>
                            </div>
                            <div class="flex flex-col gap-1" id="shelf-shared-left"></div>
                        </div>
                    </div>

                    <!-- Personal Shelf -->
                    <div class="flex flex-col items-center flex-grow max-w-[300px] order-3 md:order-2 w-full">
                        <div class="obj-card-common w-full mb-2 p-2 relative">
                            <div
                                class="absolute -top-3 left-1/2 -translate-x-1/2 w-8 h-4 bg-red-500 opacity-80 rotate-3">
                            </div>
                            <div class="flex justify-between items-start">
                                <div><span class="text-xs font-bold text-red-600 block">MEMO BOSS</span><span
                                        class="text-xs md:text-sm leading-none">"Almeno 1 Horror condiviso!"</span>
                                </div>
                                <div
                                    class="w-6 h-6 bg-black border border-white rounded-sm flex items-center justify-center text-[10px] text-white font-bold ml-1">
                                    HOR</div>
                            </div>
                        </div>

                        <div class="text-sm font-bold bg-yellow-300 px-4 border-2 border-black mb-1 rotate-2 shadow-md">
                            IL TUO SCAFFALE</div>
                        <div class="bg-amber-100 border-4 border-amber-800 p-2 grid grid-cols-5 gap-1 w-full shadow-inner"
                            id="shelf-personal"></div>

                        <!-- HAND (Interactive) -->
                        <div class="mt-2 min-h-[70px] w-full bg-slate-800 rounded border-2 border-gray-500 p-2 flex gap-2 justify-center items-center transition-all flex-wrap"
                            id="player-hand"></div>

                        <div class="obj-card-personal w-full mt-2 p-2 flex items-center gap-2">
                            <div
                                class="w-8 h-8 rounded-full border-2 border-red-800 flex items-center justify-center transform -rotate-12 bg-white flex-shrink-0">
                                <span class="text-[8px] font-bold text-red-800 leading-none">TOP<br>SECRET</span>
                            </div>
                            <div class="flex-grow"><span
                                    class="text-xs font-bold text-blue-800 block">OBIETTIVO</span><span
                                    class="text-xs md:text-sm leading-none">Colonna centrale Family</span></div>
                        </div>
                    </div>

                    <!-- Shared Right -->
                    <div class="flex flex-col items-center order-2 md:order-3">
                        <div class="text-sm font-bold bg-white px-2 border border-black mb-1 rotate-3">Shared DX</div>
                        <div
                            class="bg-orange-200 border-2 border-black p-1 grid grid-cols-2 gap-1 w-[80px] md:w-[100px]">
                            <div class="flex flex-col gap-1" id="shelf-shared-right"></div>
                            <div class="flex flex-col gap-1 opacity-50 bg-gray-300">
                                <div class="slot h-8 w-full"></div>
                                <div class="slot h-8 w-full"></div>
                                <div class="slot h-8 w-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discard Box -->
                <div class="w-full flex justify-end px-4 mt-4 order-4">
                    <div id="discard-box"
                        class="discard-zone w-24 h-24 border-4 border-black bg-gray-800 text-white flex flex-col items-center justify-center rounded-lg shadow-lg rotate-6 transition-transform">
                        <span class="text-xs uppercase font-bold text-center">Resi (Tocca qui)</span>
                        <span id="discard-count" class="text-3xl font-bangers text-red-500">0/10</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTACT FOOTER -->
    <footer id="contacts-footer"
        class="w-full text-center mt-12 mb-4 p-6 border-4 border-black bg-yellow-400 shadow-[8px_8px_0_rgba(0,0,0,1)] transform rotate-1">
        <h3 class="text-2xl font-bangers mb-4 text-black">üëã PARLIAMO?</h3>
        <div class="flex flex-col md:flex-row justify-center items-center gap-6 font-bold text-2xl text-black">
            <a href="mailto:massi.sabato@gmail.com"
                class="hover:text-white hover:bg-black px-3 py-1 rounded transition-all flex items-center gap-2 border-2 border-transparent hover:border-white">
                üìß massi.sabato@gmail.com
            </a>
            <a href="https://wa.me/393295644852" target="_blank"
                class="hover:text-white hover:bg-green-600 px-3 py-1 rounded transition-all flex items-center gap-2 border-2 border-transparent hover:border-white">
                üí¨ WhatsApp
            </a>
            <a href="https://linktr.ee/JustMax76" target="_blank"
                class="hover:text-white hover:bg-purple-600 px-3 py-1 rounded transition-all flex items-center gap-2 border-2 border-transparent hover:border-white">
                üå≤ Linktree
            </a>
        </div>
    </footer>

    <!-- AUDIO & VISUAL EFFECTS -->
    <div id="sound-effect"
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-bangers text-yellow-500 shadow-black drop-shadow-lg pointer-events-none opacity-0 transition-opacity duration-200 z-50">
        CLUNK!</div>

    <script>
        // --- GAME DATA & STATE ---
        const genres = [
            { id: 'act', name: 'Action', color: 'tape-red' },
            { id: 'fam', name: 'Family', color: 'tape-blue' },
            { id: 'com', name: 'Comedy', color: 'tape-yellow' },
            { id: 'hor', name: 'Horror', color: 'tape-black' }
        ];

        let state = {
            managerPos: 0,
            piles: [],
            hand: [],
            personalShelf: Array(15).fill(null),
            sharedLeft: Array(3).fill(null),
            sharedRight: Array(3).fill(null),
            discardCount: 0,
            step: 0, // 0: Move, 1: Take, 2: Place (Interactive)
            selectedTapeIdx: null // Which tape in hand is active
        };

        // --- INIT ---
        function initGame() {
            state.piles = [];
            for (let i = 0; i < 8; i++) {
                let pile = [];
                let count = 4;
                for (let j = 0; j < count; j++) {
                    pile.push(genres[Math.floor(Math.random() * genres.length)]);
                }
                state.piles.push(pile);
            }
            state.personalShelf = Array(15).fill(null);
            state.sharedLeft = Array(3).fill(null);
            state.sharedRight = Array(3).fill(null);
            state.hand = [];
            state.managerPos = 0;
            state.discardCount = 0;
            state.step = 0;
            state.selectedTapeIdx = null;

            updateControls();
            renderBoard();
            updateStatus("Tocca a te! Scegli di quanto muovere il Manager.");
        }

        // --- CONTROLS LOGIC ---
        function updateControls() {
            const container = document.getElementById('controls-container');
            container.innerHTML = '';

            // Update Progress Bar
            [0, 1, 2, 3].forEach(step => {
                const el = document.getElementById(`seq-step-${step}`);
                if (el) {
                    // Calculate state logic for 4th step (Passa) which shares state 2 somewhat
                    let isActive = false;
                    if (step === 3 && state.step === 2 && state.hand.length === 0) isActive = true; // Ready to pass
                    else if (step === state.step && !(step === 2 && state.hand.length === 0)) isActive = true;

                    if (isActive) {
                        el.classList.remove('opacity-40');
                        el.classList.add('opacity-100', 'scale-110');
                    } else {
                        el.classList.add('opacity-40');
                        el.classList.remove('opacity-100', 'scale-110');
                    }
                }
            });

            if (state.step === 0) {
                // MOVE PHASE
                container.innerHTML = `
                    <button onclick="manualMove(1)" class="bg-blue-600 text-white px-4 py-2 rounded font-bold border-2 border-black hover:bg-blue-500 shadow-md active:translate-y-1">Muovi 1</button>
                    <button onclick="manualMove(2)" class="bg-blue-600 text-white px-4 py-2 rounded font-bold border-2 border-black hover:bg-blue-500 shadow-md active:translate-y-1">Muovi 2</button>
                    <button onclick="initGame()" class="bg-red-500 text-white px-2 py-2 rounded border-2 border-black hover:bg-red-400">Reset</button>
                `;
            } else if (state.step === 1) {
                // TAKE PHASE
                container.innerHTML = `
                    <button onclick="manualTake()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold border-2 border-black hover:bg-purple-500 shadow-md active:translate-y-1 animate-pulse">Prendi Cassette</button>
                    <button onclick="initGame()" class="bg-red-500 text-white px-2 py-2 rounded border-2 border-black hover:bg-red-400">Reset</button>
                `;
            } else if (state.step === 2) {
                // PLACE PHASE
                container.innerHTML = `
                    <div class="text-sm font-bold text-blue-900 bg-white px-2 py-1 border border-black rounded shadow">Fase Piazzamento</div>
                    <button onclick="endTurn()" class="bg-green-600 text-white px-4 py-2 rounded font-bold border-2 border-black hover:bg-green-500 shadow-md active:translate-y-1">Fine Turno</button>
                `;
            }
        }

        // --- ACTIONS ---

        function manualMove(steps) {
            state.managerPos = (state.managerPos + steps) % 8;
            playSound("STEP!");
            state.step = 1;
            renderBoard();
            updateControls();
            updateStatus("Manager in posizione. Clicca 'Prendi Cassette'.");
        }

        function manualTake() {
            const tapes = state.piles[state.managerPos];
            if (tapes.length === 0) {
                updateStatus("Pila vuota! Nessuna cassetta presa.");
            } else {
                state.hand = [...state.hand, ...tapes];
                state.piles[state.managerPos] = [];
                playSound("GRAB!");
            }
            state.step = 2;
            renderBoard();
            updateControls();
            updateStatus("Clicca su una cassetta in mano, poi su uno slot vuoto o sui Resi.");
        }

        // --- INTERACTIVE PLACEMENT LOGIC ---

        function selectHandTape(idx) {
            if (state.step !== 2) return;
            // Toggle selection
            if (state.selectedTapeIdx === idx) {
                state.selectedTapeIdx = null; // Deselect
            } else {
                state.selectedTapeIdx = idx;
                playSound("TICK");
            }
            renderBoard(); // Re-render to show selection styling
        }

        function placeInSlot(zone, idx) {
            if (state.step !== 2 || state.selectedTapeIdx === null) return;

            const tape = state.hand[state.selectedTapeIdx];

            // Logic based on zone
            let targetArray = null;
            if (zone === 'personal') targetArray = state.personalShelf;
            else if (zone === 'sharedLeft') targetArray = state.sharedLeft;
            else if (zone === 'sharedRight') targetArray = state.sharedRight;

            // Check if empty
            if (targetArray[idx] === null) {
                targetArray[idx] = tape;
                // Remove from hand
                state.hand.splice(state.selectedTapeIdx, 1);
                state.selectedTapeIdx = null;
                playSound("POP!");
                renderBoard();

                if (state.hand.length === 0) updateStatus("Mano vuota. Clicca 'Fine Turno'.");
            } else {
                playSound("NOPE");
                updateStatus("Slot occupato!");
            }
        }

        function discardSelected() {
            if (state.step !== 2 || state.selectedTapeIdx === null) return;

            // Discard logic
            state.hand.splice(state.selectedTapeIdx, 1);
            state.discardCount++;
            state.selectedTapeIdx = null;

            playSound("TRASH!");
            renderBoard();
            if (state.hand.length === 0) updateStatus("Mano vuota. Clicca 'Fine Turno'.");
        }

        function endTurn() {
            if (state.hand.length > 0) {
                // Auto discard remaining
                state.discardCount += state.hand.length;
                state.hand = [];
                playSound("SWEEP!");
            }

            if (state.discardCount >= 10) {
                updateStatus("BOX PIENO! MALUS APPLICATO! (Turno finito)");
                playSound("ALARM!");
            } else {
                updateStatus("Turno finito. Tocca al prossimo!");
            }

            // Reset to phase 0
            state.step = 0;
            state.selectedTapeIdx = null;
            updateControls();
            renderBoard();
        }

        // --- RENDER FUNCTIONS ---
        function renderBoard() {
            // Piles
            for (let i = 0; i < 8; i++) {
                const pileEl = document.getElementById(`pile-${i}`);
                pileEl.innerHTML = '';
                state.piles[i].forEach((tape, idx) => {
                    const t = document.createElement('div');
                    t.className = `absolute w-8 h-10 border border-black rounded shadow-sm ${tape.color}`;
                    const rot = (idx % 2 === 0) ? -3 : 3;
                    t.style.top = `${-idx * 4}px`; t.style.left = `${idx * 2}px`;
                    t.style.transform = `rotate(${rot}deg)`;
                    pileEl.appendChild(t);
                });
            }

            // Manager
            const manager = document.getElementById('manager-meeple');
            // Responsive sizing for desk center
            const isMobile = window.innerWidth < 768;
            const radius = isMobile ? 115 : 130;
            const center = isMobile ? 144 : 160;

            const angleDeg = (state.managerPos * 45) - 90;
            const angleRad = angleDeg * (Math.PI / 180);
            manager.style.left = `${center + radius * Math.cos(angleRad) - 20}px`;
            manager.style.top = `${center + radius * Math.sin(angleRad) - 20}px`;
            manager.style.transform = `rotate(${state.managerPos * 45}deg)`;

            // Hand (Interactive)
            const handEl = document.getElementById('player-hand');
            handEl.innerHTML = '';
            if (state.hand.length === 0) {
                handEl.innerHTML = '<span class="text-gray-500 text-xs italic">La tua mano √® vuota</span>';
                handEl.classList.remove('ring-4', 'ring-yellow-400');
            } else {
                if (state.step === 2) handEl.classList.add('ring-4', 'ring-yellow-400');
                else handEl.classList.remove('ring-4', 'ring-yellow-400');

                state.hand.forEach((tape, idx) => {
                    const t = document.createElement('div');
                    // Add interactivity if step 2
                    let clickableClass = (state.step === 2) ? 'cursor-pointer' : '';
                    let selectedClass = (idx === state.selectedTapeIdx) ? 'selected' : '';

                    t.className = `vhs-tape ${tape.color} ${clickableClass} ${selectedClass}`;
                    t.innerText = tape.name.substring(0, 3);

                    if (state.step === 2) {
                        t.onclick = (e) => {
                            e.stopPropagation(); // Prevent bubbling
                            selectHandTape(idx);
                        };
                    }
                    handEl.appendChild(t);
                });
            }

            // Shelves (Interactive Targets)
            renderShelf('shelf-personal', state.personalShelf, 'personal');
            renderShelf('shelf-shared-left', state.sharedLeft, 'sharedLeft');
            renderShelf('shelf-shared-right', state.sharedRight, 'sharedRight');

            // Discard Box (Interactive Target)
            const discardBox = document.getElementById('discard-box');
            document.getElementById('discard-count').innerText = `${state.discardCount}/10`;

            if (state.step === 2 && state.selectedTapeIdx !== null) {
                discardBox.classList.add('playable', 'border-yellow-400');
                discardBox.onclick = () => discardSelected();
            } else {
                discardBox.classList.remove('playable', 'border-yellow-400');
                discardBox.onclick = null;
            }

            if (state.discardCount >= 10) document.getElementById('discard-count').classList.add('text-red-600', 'animate-pulse');
        }

        function renderShelf(elementId, dataArray, zoneName) {
            const el = document.getElementById(elementId);
            el.innerHTML = '';

            dataArray.forEach((slot, idx) => {
                const d = document.createElement('div');
                let slotContent = '';
                let extraClass = '';
                let clickHandler = null;

                if (slot) {
                    slotContent = `<div class="vhs-tape ${slot.color} scale-75 cursor-default">${slot.name.substring(0, 3)}</div>`;
                } else {
                    // Empty slot logic
                    if (state.step === 2 && state.selectedTapeIdx !== null) {
                        extraClass = 'playable';
                        clickHandler = () => placeInSlot(zoneName, idx);
                    }
                }

                d.className = `slot bg-white ${extraClass}`;
                d.innerHTML = slotContent;
                if (clickHandler) d.onclick = clickHandler;

                el.appendChild(d);
            });
        }

        // --- UTILS ---
        function playSound(text) {
            const el = document.getElementById('sound-effect');
            el.innerText = text;
            el.style.opacity = 1;
            el.style.transform = 'translate(-50%, -50%) scale(1.5) rotate(-10deg)';
            setTimeout(() => {
                el.style.opacity = 0;
                el.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)';
            }, 500);
        }

        function updateStatus(msg) {
            document.getElementById('game-status').innerText = `STATUS: ${msg}`;
        }

        function switchTab(tabId) {
            ['intro', 'turn'].forEach(id => document.getElementById(`content-${id}`).classList.add('hidden'));
            document.getElementById(`content-${tabId}`).classList.remove('hidden');

            // --- Hide Simulator if Intro is active ---
            const rightCol = document.getElementById('right-column');
            const leftCol = document.getElementById('left-column');
            const btns = document.querySelectorAll('.tab-btn');

            btns.forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tabId}`).classList.add('active');

            if (tabId === 'intro') {
                rightCol.classList.add('hidden');
                leftCol.classList.remove('lg:col-span-4');
                leftCol.classList.add('lg:col-span-12'); // Full width
            } else {
                rightCol.classList.remove('hidden');
                leftCol.classList.remove('lg:col-span-12');
                leftCol.classList.add('lg:col-span-4'); // Restore width
            }
        }

        // --- SOUNDCLOUD AUDIO ENGINE ---
        let scWidget = null;
        let isPlaying = false;
        let currentPos = 0;

        function initAudio() {
            // Load SoundCloud Widget API
            const script = document.createElement('script');
            script.src = "https://w.soundcloud.com/player/api.js";
            script.onload = () => {
                const iframe = document.getElementById('sc-widget');
                scWidget = SC.Widget(iframe);

                // Bind events
                scWidget.bind(SC.Widget.Events.READY, () => {
                    console.log('Audio Ready');

                    // --- RESTORE STATE ---
                    const storedPos = sessionStorage.getItem('audio_pos');
                    const storedPlaying = sessionStorage.getItem('audio_playing');

                    if (storedPos) {
                        currentPos = parseFloat(storedPos);
                        scWidget.seekTo(currentPos);
                    }

                    // Attempt to auto-resume if it was playing
                    if (storedPlaying === 'true') {
                        setTimeout(() => {
                            scWidget.play();
                            isPlaying = true;
                            // Update UI
                            const btn = document.getElementById('btn-music');
                            if (btn) {
                                btn.innerText = "üéµ AUDIO: ON";
                                btn.classList.add('bg-green-600');
                                btn.classList.remove('bg-slate-800');
                            }
                        }, 100);
                    }
                });

                scWidget.bind(SC.Widget.Events.FINISH, () => {
                    console.log('Track Finished');
                });

                // Track progress
                scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, (data) => {
                    currentPos = data.currentPosition;
                });
            };
            document.head.appendChild(script);

            // --- SAVE STATE ON UNLOAD ---
            window.addEventListener('beforeunload', () => {
                sessionStorage.setItem('audio_pos', currentPos);
                sessionStorage.setItem('audio_playing', isPlaying);
            });
        }

        function toggleMusic() {
            const btn = document.getElementById('btn-music');

            if (!scWidget) return;

            scWidget.isPaused((paused) => {
                if (paused) {
                    scWidget.play();
                    isPlaying = true;
                    btn.innerText = "üéµ AUDIO: ON";
                    btn.classList.add('bg-green-600');
                    btn.classList.remove('bg-slate-800');
                } else {
                    scWidget.pause();
                    isPlaying = false;
                    btn.innerText = "üéµ AUDIO: OFF";
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-slate-800');
                }
            });
        }

        // --- SPLASH SCREEN LOGIC ---
        function dismissSplash() {
            const splash = document.getElementById('splash-screen');
            if (!splash) return;

            // Start Audio
            if (scWidget) {
                scWidget.play();
                isPlaying = true;
                const btn = document.getElementById('btn-music');
                btn.innerText = "üéµ AUDIO: ON";
                btn.classList.add('bg-green-600');
                btn.classList.remove('bg-slate-800');
            }

            // Initialize UI State
            switchTab('intro');

            splash.style.opacity = '0';
            setTimeout(() => {
                splash.remove();
            }, 800);
        }

        function playSplashJingle() {
            // Deprecated - Audio now handled by SoundCloud auto-start
        }

        // --- SPLASH BACKGROUND GENERATOR ---
        function generateBackgroundTapes() {
            const container = document.getElementById('splash-bg');
            // VHS PNG Assets
            const tapeImages = [
                'vhs-blk.png', 'vhs-blu.png', 'vhs-gre.png',
                'vhs-ora.png', 'vhs-pin.png', 'vhs-pur.png',
                'vhs-red.png', 'vhs-whi.png', 'vhs-yel.png'
            ];
            // Increased count to show variety
            const numTapes = 12;

            for (let i = 0; i < numTapes; i++) {
                const tape = document.createElement('div');
                tape.classList.add('bg-tape');
                tape.classList.add('shift-colors'); // Enable Color Shift Animation

                // Pick Image - Ensure variety by cycling then randomizing
                let imgIndex = i % tapeImages.length;
                if (i >= tapeImages.length) imgIndex = Math.floor(Math.random() * tapeImages.length);
                const randomImg = tapeImages[imgIndex];

                tape.style.backgroundImage = `url('${randomImg}')`;

                // Random Position (Spread out)
                tape.style.left = (Math.random() * 90 - 5) + '%';
                tape.style.top = (Math.random() * 90 - 5) + '%';

                // Random Scale (0.5 to 1.3)
                const baseScale = Math.random() * 0.8 + 0.5;
                tape.style.setProperty('--base-scale', baseScale);

                // Random Opacity (0.4 to 0.8) - Lowered per user request
                const opacity = Math.random() * 0.4 + 0.4;
                tape.style.setProperty('--tape-opacity', opacity);

                // Random Rotation Init
                const rot = Math.random() * 360;
                tape.style.transform = `rotate(${rot}deg) scale(${baseScale})`;

                // Random Animation Vars
                const floatDuration = Math.random() * 15 + 15 + 's'; // 15-30s
                const floatDelay = Math.random() * -30 + 's';
                const shiftDuration = Math.random() * 20 + 10 + 's'; // 10-30s color cycle

                tape.style.setProperty('--float-duration', floatDuration);
                tape.style.setProperty('--float-delay', floatDelay);
                tape.style.setProperty('--shift-duration', shiftDuration);

                container.appendChild(tape);
            }
        }

        generateBackgroundTapes();

        window.onload = () => {
            // Check if we should skip splash immediately
            if (sessionStorage.getItem('skip_splash') === 'true') {
                console.log("Skipping splash screen...");
                // CONSUME THE FLAG so it doesn't persist on refresh
                sessionStorage.removeItem('skip_splash');

                const splash = document.getElementById('splash-screen');
                if (splash) splash.remove(); // Completely remove it
                switchTab('intro');
                initGame();
                initAudio();
            } else {
                initGame();
                initAudio();
            }
        };
    </script>
</body>

</html>